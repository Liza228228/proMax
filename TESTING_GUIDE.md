# Руководство по тестированию

## Содержание
1. [Введение](#введение)
2. [Настройка окружения](#настройка-окружения)
3. [Запуск тестов](#запуск-тестов)
4. [Тестовые сценарии](#тестовые-сценарии)
5. [Устранение неполадок](#устранение-неполадок)

---

## Введение

Данное руководство описывает процесс настройки и запуска автоматизированных тестов для информационной системы кондитерской.

Проект использует:
- **Laravel 11** - PHP фреймворк
- **PHPUnit** - фреймворк для тестирования
- **SQLite** - легковесная база данных для тестирования
- **Laravel Feature Tests** - функциональные тесты

---

## Настройка окружения

### Шаг 1: Установка зависимостей

Убедитесь, что у вас установлены все необходимые зависимости:

```bash
composer install
```

### Шаг 2: Настройка базы данных для тестов

Тесты используют SQLite in-memory базу данных для изоляции тестовых данных.

#### Включение SQLite драйверов в PHP

1. Откройте файл `php.ini` (путь можно узнать командой `php --ini`)
2. Найдите и раскомментируйте следующие строки (уберите `;` в начале):

```ini
extension=pdo_sqlite
extension=sqlite3
```

3. Перезапустите веб-сервер или PHP-FPM

#### Проверка поддержки SQLite

Выполните команду для проверки:

```bash
php -m | grep -i sqlite
```

Вы должны увидеть:
```
pdo_sqlite
sqlite3
```

### Шаг 3: Настройка конфигурации тестов

Файл `phpunit.xml` уже настроен для использования SQLite:

```xml
<env name="DB_CONNECTION" value="sqlite"/>
<env name="DB_DATABASE" value=":memory:"/>
```

---

## Запуск тестов

### Запуск всех тестов

Для запуска всех тестов в проекте:

```bash
php artisan test
```

### Запуск конкретной группы тестов

Для запуска только тестовых сценариев (TC-001 до TC-006):

```bash
php artisan test --group=test-scenarios
```

Или через composer:

```bash
composer test-scenarios
```

### Запуск с подробным выводом

Для вывода результатов в читаемом формате на русском языке:

```bash
php artisan test --group=test-scenarios --testdox
```

### Запуск конкретного теста

Для запуска конкретного тестового класса:

```bash
php artisan test tests/Feature/Admin/ProductManagementTest.php
```

Для запуска конкретного метода:

```bash
php artisan test --filter=test_admin_can_create_product_with_images_and_recipe
```

---

## Тестовые сценарии

Проект включает 6 основных тестовых сценариев:

### TC-001: Просмотр каталога с фильтрацией
- **Файл:** `tests/Feature/CatalogFilterTest.php`
- **Роль:** Гость
- **Описание:** Проверка корректной работы фильтров каталога по категориям и цене

### TC-002: Создание продукции с изображениями и рецептом (Позитивный)
- **Файл:** `tests/Feature/Admin/ProductManagementTest.php`
- **Роль:** Администратор
- **Описание:** Проверка успешного создания товара со всеми обязательными атрибутами

### TC-003: Генерация PDF-отчета по заказам
- **Файл:** `tests/Feature/Admin/ReportGenerationTest.php`
- **Роль:** Администратор
- **Описание:** Проверка формирования отчетности в формате PDF

### TC-004: Создание продукции без изображений (Негативный)
- **Файл:** `tests/Feature/Admin/ProductManagementTest.php`
- **Роль:** Администратор
- **Описание:** Проверка валидации обязательных полей (изображения)

### TC-005: Перемещение ингредиентов между складами (Негативный)
- **Файл:** `tests/Feature/Manager/WarehouseTransferTest.php`
- **Роль:** Менеджер
- **Описание:** Проверка контроля остатков при перемещении ингредиентов

### TC-006: Добавление товара с некорректной датой срока годности (Негативный)
- **Файл:** `tests/Feature/Admin/StockManagementTest.php`
- **Роль:** Администратор
- **Описание:** Проверка валидации дат срока годности

---

## Структура тестов

Каждый тест следует паттерну AAA (Arrange-Act-Assert):

```php
/**
 * @group test-scenarios
 * @testdox Описание теста на русском языке
 */
public function test_example(): void
{
    // === ARRANGE === (Подготовка)
    // Создание тестовых данных
    
    // === ACT === (Действие)
    // Выполнение тестируемого действия
    
    // === ASSERT === (Проверка)
    // Проверка результатов
}
```

### Используемые трейты

- `RefreshDatabase` - автоматическая очистка базы данных между тестами

### Используемые аннотации

- `@group test-scenarios` - группировка тестов для удобного запуска
- `@testdox` - человекочитаемое описание теста на русском языке

---

## Устранение неполадок

### Проблема: "could not find driver"

**Ошибка:**
```
SQLSTATE[HY000]: could not find driver (Connection: sqlite, SQL: select exists...)
```

**Решение:**
1. Убедитесь, что расширения SQLite включены в `php.ini`
2. Перезапустите веб-сервер
3. Проверьте: `php -m | grep sqlite`

### Проблема: "HAVING clause on a non-aggregate query"

**Ошибка:**
```
SQLSTATE[HY000]: General error: 1 HAVING clause on a non-aggregate query
```

**Решение:**
Эта проблема была решена в коде приложения. SQLite имеет более строгие требования к SQL-запросам.
В `app/Http/Controllers/CatalogController.php` фильтрация категорий по количеству товаров выполняется в PHP, а не в SQL.

### Проблема: Тесты падают из-за отсутствующих таблиц

**Решение:**
Убедитесь, что миграции выполняются корректно. Проверьте настройки в `phpunit.xml`:

```xml
<env name="DB_CONNECTION" value="sqlite"/>
<env name="DB_DATABASE" value=":memory:"/>
```

### Проблема: Тесты проходят локально, но падают на CI/CD

**Решение:**
1. Проверьте версию PHP на CI/CD сервере
2. Убедитесь, что SQLite расширения установлены на сервере
3. Проверьте переменные окружения

---

## Continuous Integration

### GitHub Actions

Пример конфигурации `.github/workflows/tests.yml`:

```yaml
name: Tests

on: [push, pull_request]

jobs:
  tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2
        extensions: pdo, pdo_sqlite, sqlite3
    
    - name: Install Dependencies
      run: composer install
    
    - name: Run Tests
      run: php artisan test --group=test-scenarios
```

---

## Дополнительные команды

### Очистка кэша перед тестами

```bash
php artisan config:clear
php artisan cache:clear
```

### Генерация отчета о покрытии кода

```bash
php artisan test --coverage
```

### Запуск тестов с детальным выводом

```bash
php artisan test --verbose
```

---

## Лучшие практики

1. **Изоляция тестов**: Каждый тест должен быть независимым
2. **Минимальные данные**: Создавайте только необходимые данные для теста
3. **Понятные имена**: Используйте описательные имена методов тестов
4. **Документация**: Добавляйте комментарии и аннотации `@testdox`
5. **Группировка**: Используйте `@group` для логической группировки тестов

---

## Контакты

При возникновении проблем с тестами обращайтесь к:
- Руководителю проекта
- Документации Laravel: https://laravel.com/docs/testing
- Документации PHPUnit: https://phpunit.de/documentation.html

---

**Последнее обновление:** Декабрь 2024

